{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="my-books-container d-flex gap-4">

    <!-- Sidebar Filters -->
    <div class="filters-sidebar">
        <h5>Filter By</h5>

        <!-- Clear Filters Button -->
        <div class="mb-3">
            <a href="{% url 'my_books' %}" class="btn btn-sm btn-outline-secondary w-100">Clear Filters</a>
        </div>

        <!-- Author Filter -->
        <div class="status">
            <p>Author</p>
            <div class="filter-badges-container scrollable-badges">
                {% for author in authors %}
                <a href="?author={{ author }}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}"
                    class="badge filter-badge {% if selected_author == author %}active{% endif %}">{{ author }}</a>
                {% endfor %}
            </div>
        </div>

        <!-- Tags Filter -->
        <div class="status">
            <p>Tags</p>
            <div class="filter-badges-container scrollable-badges">
                {% for tag in tags %}
                <a href="?tag={{ tag }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}"
                    class="badge filter-badge {% if selected_tag == tag %}active{% endif %}">{{ tag }}</a>
                {% endfor %}
            </div>
        </div>

        <!-- Status Filter -->
        <div class="status">
            <p>Status</p>
            <div class="filter-badges-container scrollable-badges">
                {% for status in statuses %}
                <a href="?status={{ status }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}"
                    class="badge filter-badge {% if selected_status == status %}active{% endif %}">{{ status }}</a>
                {% endfor %}
            </div>
        </div>

        <!-- Ratings Filter -->
        <div class="status">
            <p>Ratings</p>
            <div class="filter-badges-container scrollable-badges">
                {% for i in ratings %}
                <a href="?rating={{ i }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}"
                    class="badge rating-badge {% if selected_rating|default:'' == i|stringformat:"s" %}active{% endif %}">{{ i }}â˜…</a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="books-main flex-grow-1">
        <!-- Top Bar with Book Count, Pagination, and Sort -->
        <div class="sort-bar d-flex justify-content-between align-items-center mb-3">
            <!-- Book Count -->
            <div class="results-count">
                <span class="status">{{ page_obj.paginator.count }} books found</span>
            </div>
            
            <!-- Centered Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Top pagination" class="top-pagination">
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ page_obj.previous_page_number }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                           &laquo; Prev
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if num == page_obj.number %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:-2 and num < page_obj.number|add:2 %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?page={{ num }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ page_obj.next_page_number }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                           Next &raquo;
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            <!-- Sort Dropdown -->
            <div class="dropdown">
                <i class="fas fa-sort-amount-down-alt sort-icon" data-bs-toggle="dropdown"></i>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item"
                           href="?sort=title{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}">Title</a></li>
                    <li><a class="dropdown-item"
                           href="?sort=author{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}">Author</a></li>
                    <li><a class="dropdown-item"
                           href="?sort=rating{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}">Rating</a></li>
                </ul>
            </div>
        </div>

        <div class="books-grid">
            {% for book in books %}
            <div class="book-card">
                <a href="{% url 'book_detail' book.pk %}">
                    {% if book.cover_image %}
                    <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
                    {% else %}
                    <div class="placeholder-book">ðŸ“–</div>
                    {% endif %}
                    <p class="book-title">{{ book.title }}</p>
                </a>
            </div>
            {% empty %}
            <p>No books found with selected filters.</p>
            {% endfor %}
        </div>
        
        <!-- Bottom Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ page_obj.previous_page_number }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                       &laquo; Prev
                    </a>
                </li>
                {% endif %}
        
                {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ num }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
        
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ page_obj.next_page_number }}{% if selected_author %}&author={{ selected_author }}{% endif %}{% if selected_tag %}&tag={{ selected_tag }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_rating %}&rating={{ selected_rating }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                       Next &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    
        // Make clicking the same filter again unselect it
        document.querySelectorAll('.filter-badge, .rating-badge').forEach(badge => {
            badge.addEventListener('click', function (e) {
                e.preventDefault(); // stop default link click
                const url = new URL(window.location.href);
                const clickedHref = new URL(this.href, window.location.origin);
    
                // Get the query params from the clicked badge
                const clickedParams = clickedHref.searchParams;
    
                // Figure out what filter type this is (tag, author, status, rating)
                const keys = ['tag', 'author', 'status', 'rating'];
                let key = null;
                for (const k of keys) {
                    if (clickedParams.has(k)) {
                        key = k;
                        break;
                    }
                }
    
                if (!key) return;
    
                const selectedValue = clickedParams.get(key);
                const currentValue = url.searchParams.get(key);
    
                if (selectedValue === currentValue) {
                    // User clicked the same active filter â†’ remove it
                    url.searchParams.delete(key);
                } else {
                    // User clicked a new filter â†’ set it
                    url.searchParams.set(key, selectedValue);
                }
    
                // Always reset to page 1 when changing filters
                url.searchParams.delete('page');
    
                // Redirect with updated params
                window.location.href = url.toString();
            });
        });
    
        // Reorganize badges to show active ones first
        function organizeBadges() {
            document.querySelectorAll('.filter-badges-container').forEach(container => {
                const badges = Array.from(container.querySelectorAll('.filter-badge, .rating-badge'));
                badges.sort((a, b) => {
                    const aIsActive = a.classList.contains('active');
                    const bIsActive = b.classList.contains('active');
                    return aIsActive === bIsActive ? 0 : aIsActive ? -1 : 1;
                });
                badges.forEach(badge => container.appendChild(badge));
            });
        }
    
        organizeBadges();
    });
    </script>
    

<style>
    /* Pagination styles using your existing CSS variables */
    .pagination .page-link {
        color: var(--text-primary);
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        margin: 0 3px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .pagination .page-link:hover {
        background: var(--bg-secondary);
        border-color: var(--accent-orange);
        color: var(--text-primary);
        transform: translateY(-1px);
    }

    .pagination .active .page-link {
        background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
        border-color: var(--accent-orange);
        color: white;
        box-shadow: 0 2px 8px var(--card-shadow);
    }

    .pagination-sm .page-link {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }

    /* Sort bar layout */
    .sort-bar {
        background: var(--bg-card);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        border: 2px solid var(--border-color);
        box-shadow: 0 4px 12px var(--card-shadow);
    }

    .results-count {
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* Center the top pagination */
    .top-pagination {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    .sort-bar {
        position: relative;
    }
</style>
{% endblock %}